---
- name: Logging Setup für Linux EC2
  hosts: linuxhosts
  become: yes
  gather_facts: yes
  tasks:

    - name: Definiere Softwareliste
      set_fact:
        software_list:
          - App1
          - App2
          - App3

    - name: Prüfe, ob Software baremetal/container/not running
      shell: |
        NAME="{{ item }}"
        # Prüfe Bare-Metal (systemd oder Prozess)
        if command -v systemctl >/dev/null 2>&1; then
          if systemctl is-active --quiet "$NAME"; then
            echo "baremetal"
            exit 0
          fi
        fi
        if pgrep -f "$NAME" >/dev/null 2>&1; then
          echo "baremetal"
          exit 0
        fi

        # Prüfe Docker-Container (falls Docker verfügbar)
        if command -v docker >/dev/null 2>&1; then
          if docker ps --format '{{"{{"}}.Names{{"}}"}} {{"{{"}}.Image{{"}}"}}' | grep -i -E "\b$NAME\b" >/dev/null 2>&1; then
            echo "container"
            exit 0
          fi
        fi

        # Weder Bare-Metal noch Container gefunden
        echo "not running"
      register: software_status
      loop: "{{ software_list }}"
      loop_control:
        label: "{{ item }}"

    - name: Setze software_location für jede Software
      set_fact:
        software_info: >-
          {{
            software_info | default({}) |
            combine({ item.item: item.stdout })
          }}
      loop: "{{ software_status.results }}"

    - name: Prüfe, ob Logging existiert
      stat:
        path: /var/log/myapp/logging.conf
      register: log_file

    - name: Setze logging_needed
      set_fact:
        logging_needed: "{{ not log_file.stat.exists }}"

    - name: Erstelle Logging-Verzeichnis
      file:
        path: /var/log/myapp
        state: directory
        mode: '0755'

    - name: Logging konfigurieren (nur wenn nötig)
      shell: |
        {% for sw, loc in software_info.items() %}
        echo "software={{ sw }}" >> /var/log/myapp/logging.conf
        echo "location={{ loc }}" >> /var/log/myapp/logging.conf
        echo "logging_configured=yes" >> /var/log/myapp/logging.conf
        echo "---" >> /var/log/myapp/logging.conf
        {% endfor %}
      when: logging_needed

    - name: Erstelle Logfile mit Infos für S3 (mit Datum & Uhrzeit)
      shell: |
        timestamp=$(date "+%Y-%m-%d %H:%M:%S")
        {% for sw, loc in software_info.items() %}
        {
          echo "Timestamp: $timestamp"
          echo "Software: {{ sw }}"
          echo "Location: {{ loc }}"
          echo "LoggingConfigured: yes"
          echo "---"
        } >> /var/log/myapp/logging_info.txt
        {% endfor %}

    - name: Lade Logfile zu S3
      shell: |
        aws s3 cp /var/log/myapp/logging_info.txt s3://ansible3testnow/logging_info_linux.txt --region eu-central-1
